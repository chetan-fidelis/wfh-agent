# Auto-Update Fix Guide

## Problem
Auto-update from v0.1.15 to v0.1.17 is not working.

## Root Cause
The GitHub release is missing the `latest.yml` file that electron-updater needs to detect new versions.

## Solution

### Step 1: Verify GitHub Release Assets
Your release at https://github.com/chetan-fidelis/wfh-agent/releases/tag/v0.1.17 must have:

**Required files**:
- ✅ `WFH-Agent-Setup-0.1.17.exe` (installer)
- ✅ `WFH-Agent-Setup-0.1.17.exe.blockmap` (for delta updates)
- ❌ `latest.yml` (MISSING - this is the problem!)

### Step 2: Generate latest.yml

The `latest.yml` file should be automatically generated by electron-builder. If it's missing, create it manually:

**File: `latest.yml`**
```yaml
version: 0.1.17
files:
  - url: WFH-Agent-Setup-0.1.17.exe
    sha512: <SHA512_HASH_OF_EXE>
    size: <FILE_SIZE_IN_BYTES>
path: WFH-Agent-Setup-0.1.17.exe
sha512: <SHA512_HASH_OF_EXE>
releaseDate: '2025-10-21T05:55:00.000Z'
```

### Step 3: Get SHA512 Hash

**PowerShell command**:
```powershell
Get-FileHash -Path "dist\WFH-Agent-Setup-0.1.17.exe" -Algorithm SHA512 | Select-Object -ExpandProperty Hash
```

**Or use CertUtil**:
```cmd
certutil -hashfile "dist\WFH-Agent-Setup-0.1.17.exe" SHA512
```

### Step 4: Upload latest.yml to GitHub Release

1. Go to: https://github.com/chetan-fidelis/wfh-agent/releases/tag/v0.1.17
2. Click "Edit release"
3. Drag and drop `latest.yml` to the assets
4. Click "Update release"

---

## Alternative: Rebuild with electron-builder

The proper way is to let electron-builder generate all files:

### Step 1: Clean Previous Build
```powershell
npm run clean
```

### Step 2: Build Backend
```powershell
npm run build:backend
```

### Step 3: Build Electron with Publish
```powershell
# Set GitHub token
$env:GH_TOKEN = "your_github_personal_access_token"

# Build and publish
npx electron-builder --win nsis --x64 --publish always
```

This will:
- Build the installer
- Generate `latest.yml` automatically
- Upload all files to GitHub release

---

## Verify Auto-Update is Working

### Check 1: Verify Release Files
Go to https://github.com/chetan-fidelis/wfh-agent/releases/tag/v0.1.17

Should see:
- WFH-Agent-Setup-0.1.17.exe
- WFH-Agent-Setup-0.1.17.exe.blockmap
- **latest.yml** ← Must be present!

### Check 2: Test Update Detection

On a machine with v0.1.15:

1. Open the app
2. Check `monitor_data/alerts.log` for:
   ```
   auto-updater: checking for updates...
   auto-updater: update available -> 0.1.17
   auto-updater: download 100%
   auto-updater: update downloaded -> 0.1.17
   ```

3. Or manually trigger:
   - Right-click tray icon
   - Look for "Check for Updates" option

### Check 3: Verify Update URL

The auto-updater will check:
```
https://github.com/chetan-fidelis/wfh-agent/releases/download/v0.1.17/latest.yml
```

Test this URL in browser - it should download the `latest.yml` file.

---

## Common Issues

### Issue 1: "Cannot find latest.yml"
**Solution**: Upload `latest.yml` to the release

### Issue 2: "Update check returns 404"
**Solution**: 
- Ensure release is marked as "Latest" (not pre-release)
- Check repository is public or token has access

### Issue 3: "Update available but won't download"
**Solution**: 
- Check `.exe.blockmap` file is present
- Verify SHA512 hash in `latest.yml` matches the .exe file

### Issue 4: "Auto-updater not checking"
**Solution**:
- Verify app is packaged (not running in dev mode)
- Check `app.isPackaged` is true
- Look for errors in `alerts.log`

---

## Manual latest.yml Template

If you need to create it manually, here's the exact format:

```yaml
version: 0.1.17
files:
  - url: WFH-Agent-Setup-0.1.17.exe
    sha512: PUT_SHA512_HASH_HERE
    size: PUT_FILE_SIZE_HERE
path: WFH-Agent-Setup-0.1.17.exe
sha512: PUT_SHA512_HASH_HERE
releaseDate: '2025-10-21T05:55:00.000Z'
```

**Get file size**:
```powershell
(Get-Item "dist\WFH-Agent-Setup-0.1.17.exe").Length
```

---

## Quick Fix Script

Save as `generate-latest-yml.ps1`:

```powershell
# Generate latest.yml for GitHub release

$version = "0.1.17"
$exeFile = "dist\WFH-Agent-Setup-$version.exe"

if (-not (Test-Path $exeFile)) {
    Write-Error "Installer not found: $exeFile"
    exit 1
}

# Get SHA512 hash
$hash = (Get-FileHash -Path $exeFile -Algorithm SHA512).Hash

# Get file size
$size = (Get-Item $exeFile).Length

# Get current date in ISO format
$releaseDate = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ss.fffZ")

# Generate latest.yml
$yaml = @"
version: $version
files:
  - url: WFH-Agent-Setup-$version.exe
    sha512: $hash
    size: $size
path: WFH-Agent-Setup-$version.exe
sha512: $hash
releaseDate: '$releaseDate'
"@

# Save to file
$yaml | Out-File -FilePath "dist\latest.yml" -Encoding UTF8 -NoNewline

Write-Host "✓ Generated dist\latest.yml" -ForegroundColor Green
Write-Host ""
Write-Host "Next steps:" -ForegroundColor Yellow
Write-Host "1. Go to: https://github.com/chetan-fidelis/wfh-agent/releases/tag/v$version"
Write-Host "2. Click 'Edit release'"
Write-Host "3. Upload dist\latest.yml"
Write-Host "4. Click 'Update release'"
```

**Run it**:
```powershell
.\generate-latest-yml.ps1
```

---

## Testing Auto-Update Locally

You can test the update mechanism locally:

### Step 1: Create Local Update Server

Create `test-update-server.js`:
```javascript
const http = require('http');
const fs = require('fs');
const path = require('path');

const server = http.createServer((req, res) => {
  console.log('Request:', req.url);
  
  if (req.url === '/latest.yml') {
    const yml = fs.readFileSync('dist/latest.yml', 'utf8');
    res.writeHead(200, { 'Content-Type': 'text/yaml' });
    res.end(yml);
  } else if (req.url.endsWith('.exe')) {
    const file = path.join('dist', path.basename(req.url));
    const stat = fs.statSync(file);
    res.writeHead(200, { 
      'Content-Type': 'application/octet-stream',
      'Content-Length': stat.size
    });
    fs.createReadStream(file).pipe(res);
  } else if (req.url.endsWith('.blockmap')) {
    const file = path.join('dist', path.basename(req.url));
    const data = fs.readFileSync(file);
    res.writeHead(200, { 'Content-Type': 'application/json' });
    res.end(data);
  } else {
    res.writeHead(404);
    res.end('Not found');
  }
});

server.listen(8080, () => {
  console.log('Test update server running on http://localhost:8080');
  console.log('Set updateUrl in main.js to: http://localhost:8080');
});
```

### Step 2: Modify main.js Temporarily
```javascript
// In setupAutoUpdater(), add:
autoUpdater.setFeedURL({
  provider: 'generic',
  url: 'http://localhost:8080'
});
```

### Step 3: Test
1. Run test server: `node test-update-server.js`
2. Run app with v0.1.15
3. Check for updates
4. Should detect v0.1.17

---

## Summary

**The fix is simple**: Upload `latest.yml` to your GitHub release.

**Steps**:
1. Run: `.\generate-latest-yml.ps1`
2. Upload `dist\latest.yml` to GitHub release v0.1.17
3. Users will auto-update within 4 hours (or on next app restart)

**Why it's needed**:
- electron-updater checks `latest.yml` to know if updates exist
- Without it, the updater thinks there are no new versions
- GitHub releases alone are not enough - the yml file is required

---

## Future Releases

To avoid this issue in future releases:

### Option 1: Use electron-builder publish
```powershell
$env:GH_TOKEN = "your_token"
npx electron-builder --win nsis --x64 --publish always
```

### Option 2: Always generate and upload latest.yml
After building:
```powershell
.\generate-latest-yml.ps1
# Then manually upload to GitHub release
```

### Option 3: Automate with GitHub Actions
Create `.github/workflows/release.yml` to auto-build and publish.

---

**Status**: Ready to fix  
**Time to fix**: 5 minutes  
**Impact**: All v0.1.15 users will auto-update to v0.1.17
